/**
 * Cloudflare Pages Function: /api/manage-link
 * ä½œç”¨: å¤„ç†åˆ é™¤å’Œç§»åŠ¨/ç¼–è¾‘é“¾æ¥çš„å¤æ‚é€»è¾‘ã€‚
 */

const base64Encode = (str) => btoa(unescape(encodeURIComponent(str)));
const base64Decode = (b64) => decodeURIComponent(escape(atob(b64)));

const FILE_PATH = 'src/config/nav.js';

// -----------------------------------------------------------
// è¾…åŠ©å‡½æ•° (è·å–æ–‡ä»¶)
// -----------------------------------------------------------
async function getCurrentFile(env, branchName) {
    const GITHUB_API_URL = `https://api.github.com/repos/${env.REPO_OWNER}/${env.REPO_NAME}/contents/${FILE_PATH}?ref=${branchName}`;
    if (!env.GITHUB_TOKEN) throw new Error("GitHub Tokenæœªé…ç½®ã€‚");
    const response = await fetch(GITHUB_API_URL, {
        headers: { 'Authorization': `token ${env.GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.com.v3+json', 'User-Agent': 'Cloudflare-Worker-Commit' },
    });
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`æ— æ³•è·å–æ–‡ä»¶ï¼š${response.status}. è¯¦æƒ…: ${errorText}`);
    }
    const data = await response.json();
    return { sha: data.sha, content: base64Decode(data.content) };
}

// -----------------------------------------------------------
// è¾…åŠ©å‡½æ•° (æäº¤æ–‡ä»¶)
// -----------------------------------------------------------
async function commitNewFile(sha, newContent, env, branchName, message) {
    const GITHUB_API_URL = `https://api.github.com/repos/${env.REPO_OWNER}/${env.REPO_NAME}/contents/${FILE_PATH}`;
    const encodedContent = base64Encode(newContent);
    
    const commitData = {
        message: message,
        content: encodedContent,
        sha: sha,
        branch: branchName 
    };

    const response = await fetch(GITHUB_API_URL, {
        method: 'PUT',
        headers: { 'Authorization': `token ${env.GITHUB_TOKEN}`, 'Accept': 'application/vnd.github.com.v3+json', 'Content-Type': 'application/json', 'User-Agent': 'Cloudflare-Worker-Commit' },
        body: JSON.stringify(commitData),
    });

    if (!response.ok) {
        const errorText = await response.json();
        throw new Error(`GitHub æäº¤å¤±è´¥: ${response.status} - ${errorText.message}`);
    }

    return response.json();
}

// -----------------------------------------------------------
// æ­¥éª¤ 2: ä¿®æ”¹æ–‡ä»¶å†…å®¹ (ç®¡ç†é€»è¾‘)
// -----------------------------------------------------------
function manageFileContent(oldContent, payload) {
    const { action, oldGroupTitle, originalUrl, newGroupTitle, newLink } = payload;
    
    let contentToModify = oldContent;

    // 1. ç§»é™¤æ—§é“¾æ¥ (DELETE æˆ– MOVE çš„ç¬¬ä¸€æ­¥)
    // æ­£åˆ™è¡¨è¾¾å¼ï¼šæ‰¾åˆ°ç›®æ ‡åˆ†ç»„åŠå…¶ items æ•°ç»„
    const groupRegex = new RegExp(`title:\\s*"${oldGroupTitle}"[\\s\\S]*?items:\\s*\\[([\\s\\S]*?)\\]`, 'm');
    const groupMatch = contentToModify.match(groupRegex);
    
    if (!groupMatch) {
        throw new Error(`æ— æ³•æ‰¾åˆ°ç›®æ ‡åˆ†ç»„ "${oldGroupTitle}" æˆ–å…¶ items æ•°ç»„ã€‚`);
    }

    const itemsContent = groupMatch[1]; // æ•è·åˆ°çš„ items æ•°ç»„å†…éƒ¨çš„å­—ç¬¦ä¸²å†…å®¹
    
    // æ„é€ è¦æŸ¥æ‰¾çš„æ—§é“¾æ¥çš„æ­£åˆ™ (ä½¿ç”¨ URL ä½œä¸ºæœ€å¯é çš„æ ‡è¯†)
    // é“¾æ¥æ ¼å¼: { name: "...", url: "...", icon: "..." }
    const linkRegex = new RegExp(`(\\{\\s*name:\\s*"[^"]*",\\s*icon:\\s*"[^"]*",\\s*url:\\s*"${originalUrl.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}"[\\s\\S]*?\\})`);

    const linkMatch = itemsContent.match(linkRegex);

    if (!linkMatch) {
        throw new Error(`æ— æ³•åœ¨åˆ†ç»„ "${oldGroupTitle}" ä¸­æ‰¾åˆ° URL ä¸º "${originalUrl}" çš„é“¾æ¥ã€‚`);
    }

    const linkString = linkMatch[0]; // å®Œæ•´çš„æ—§é“¾æ¥å¯¹è±¡å­—ç¬¦ä¸²
    
    // ç§»é™¤æ—§é“¾æ¥
    const newItemsContent = itemsContent.replace(linkString, '').trim();

    // é‡æ–°ç»„åˆ items æ•°ç»„å†…å®¹ (å¤„ç†é€—å·å’Œç©ºè¡Œ)
    let cleanedItemsContent = newItemsContent
        .replace(/,\s*,/g, ',') // ç§»é™¤å¤šä½™çš„é€—å·
        .replace(/,\s*$/m, '') // ç§»é™¤æœ«å°¾é€—å·
        .replace(/^\s*,/m, '') // ç§»é™¤å¼€å¤´é€—å·
        .trim();
        
    // æ›¿æ¢å›æ•´ä¸ª items æ•°ç»„å†…å®¹
    let finalContent = contentToModify.replace(itemsContent, cleanedItemsContent);
    
    // 2. æ’å…¥æ–°é“¾æ¥ (ä»…é™ MOVE/EDIT æ“ä½œ)
    if (action === 'MOVE') {
        const targetTitle = newGroupTitle;

        // æ„é€ è¦æ’å…¥çš„æ–°é“¾æ¥å­—ç¬¦ä¸²
        const insertionLinkString = `,\n      { name: "${newLink.name}", icon: "${newLink.icon}", url: "${newLink.url}" }`;
        
        // æŸ¥æ‰¾ç›®æ ‡åˆ†ç»„çš„ items æ•°ç»„çš„ç»“æŸä½ç½®
        const insertionEndRegex = new RegExp(`(title:\\s*"${targetTitle}"[\\s\\S]*?items:\\s*\\[[\\s\\S]*?)\\]`, 'm');
        const insertionMatch = finalContent.match(insertionEndRegex);
        
        if (!insertionMatch) {
            throw new Error(`æ— æ³•åœ¨ç§»åŠ¨æ“ä½œä¸­æ‰¾åˆ°ç›®æ ‡åˆ†ç»„ "${targetTitle}"ã€‚`);
        }

        const targetItemsContent = insertionMatch[1];
        const insertionPoint = insertionMatch.index + targetItemsContent.length;
        
        // æ£€æŸ¥ç›®æ ‡ items æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™ä¸éœ€è¦å¼€å¤´çš„é€—å·ã€‚
        const targetItemsInnerContent = finalContent.substring(finalContent.lastIndexOf('[', insertionPoint) + 1, insertionPoint).trim();
        let contentToInsert = insertionLinkString;
        
        if (targetItemsInnerContent === '') {
            contentToInsert = insertionLinkString.substring(1); 
        }

        finalContent = finalContent.slice(0, insertionPoint) + contentToInsert + finalContent.slice(insertionPoint);
    }
    
    return finalContent;
}


// -----------------------------------------------------------
// Cloudflare Pages Functions å…¥å£
// -----------------------------------------------------------
export async function onRequest(context) {
    try {
        if (context.request.method !== 'POST') return new Response(JSON.stringify({ success: false, message: 'åªæ”¯æŒ POST è¯·æ±‚' }), { status: 405 });
        
        const payload = await context.request.json();
        const { action, oldGroupTitle, originalUrl } = payload;
        const env = context.env;

        if (!action || !oldGroupTitle || !originalUrl) {
            return new Response(JSON.stringify({ success: false, message: 'ç®¡ç†æ“ä½œç¼ºå°‘å¿…è¦çš„å­—æ®µ (action, oldGroupTitle, originalUrl)ã€‚' }), { status: 400 });
        }
        
        const branchToUse = env.BRANCH_NAME || 'main'; 

        // æ‰§è¡Œæ–‡ä»¶æ“ä½œ
        const { sha, content } = await getCurrentFile(env, branchToUse);
        const updatedContent = manageFileContent(content, payload);
        
        let commitMessage = action === 'DELETE' ? `feat: delete link "${originalUrl}" from ${oldGroupTitle}` : `feat: move/edit link "${newLink.name}"`;
        
        const commitResponse = await commitNewFile(sha, updatedContent, env, branchToUse, commitMessage);

        return new Response(JSON.stringify({ 
            success: true, 
            message: `é“¾æ¥${action === 'DELETE' ? 'åˆ é™¤' : 'ä¿®æ”¹/ç§»åŠ¨'}æˆåŠŸï¼è¯·ç­‰å¾…éƒ¨ç½²å®Œæˆã€‚`, 
            // ğŸš€ è¿”å› Commit URL å®ç°â€œç›´æ¥è®¿é—®â€
            commit_url: commitResponse.commit.html_url 
        }), { 
            status: 200, 
            headers: { 'Content-Type': 'application/json' } 
        });

    } catch (error) {
        console.error("Function Error:", error.message);
        return new Response(JSON.stringify({ 
            success: false, 
            message: `æ“ä½œå¤±è´¥: ${error.message}` 
        }), { status: 500 });
    }
}